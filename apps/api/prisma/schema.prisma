datasource db {
  provider = "postgresql"
}

generator client {
  provider = "prisma-client-js"
}

enum Role {
  ADMIN
  MANAGER
  OPERATOR
}

enum ShiftStatus {
  OPEN
  CLOSED
}

enum AccountType {
  ASSET
  LIABILITY
  EQUITY
  INCOME
  EXPENSE
}

model User {
  id        String   @id @default(uuid())
  username  String   @unique
  password  String
  role      Role     @default(OPERATOR)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  openedShifts Shift[] @relation("ShiftOpener")
  closedShifts Shift[] @relation("ShiftCloser")
  transactions Transaction[] @relation("TransactionCreator")
}

model Shift {
  id        String      @id @default(uuid())
  startTime DateTime    @default(now())
  endTime   DateTime?
  status    ShiftStatus @default(OPEN)
  
  openerId  String
  opener    User     @relation("ShiftOpener", fields: [openerId], references: [id])
  
  closerId  String?
  closer    User?    @relation("ShiftCloser", fields: [closerId], references: [id])

  startReadings String? // JSON string of nozzle readings at start
  endReadings   String? // JSON string of nozzle readings at end

  transactions Transaction[]
  readings     NozzleReading[]
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Product {
  id            String   @id @default(uuid())
  name          String   @unique // Petrol, Diesel, lubricant
  sellingPrice  Decimal  @db.Decimal(10, 2)
  purchasePrice Decimal  @db.Decimal(10, 2)
  tanks         Tank[]
  transactions  Transaction[]
}

model Tank {
  id          String   @id @default(uuid())
  name        String
  productId   String
  product     Product  @relation(fields: [productId], references: [id])
  capacity    Decimal  @db.Decimal(10, 2)
  currentStock Decimal @db.Decimal(10, 2)
  
  nozzles     Nozzle[]
  dips        TankDip[] // Physical measurements
  purchases   Purchase[]
}

model Nozzle {
  id          String   @id @default(uuid())
  name        String
  tankId      String
  tank        Tank     @relation(fields: [tankId], references: [id])
  lastReading Decimal  @db.Decimal(15, 3) // Cumulative reading
  
  readings    NozzleReading[]
  transactions Transaction[]
}

model NozzleReading {
  id            String   @id @default(uuid())
  shiftId       String
  shift         Shift    @relation(fields: [shiftId], references: [id])
  nozzleId      String
  nozzle        Nozzle   @relation(fields: [nozzleId], references: [id])
  
  openingReading Decimal @db.Decimal(15, 3)
  closingReading Decimal? @db.Decimal(15, 3)
  
  // Computed sale = closing - opening
}

model TankDip {
  id        String   @id @default(uuid())
  tankId    String
  tank      Tank     @relation(fields: [tankId], references: [id])
  volume    Decimal  @db.Decimal(10, 2)
  measuredAt DateTime @default(now())
}

// --- Double Entry Accounting ---

model Account {
  id          String      @id @default(uuid())
  code        String      @unique // e.g., 10101
  name        String
  type        AccountType
  balance     Decimal     @default(0) @db.Decimal(15, 2)
  
  debitTx     Transaction[] @relation("DebitAccount")
  creditTx    Transaction[] @relation("CreditAccount")
}

model PaymentAccount {
  id          String   @id @default(uuid())
  name        String
  type        String   // CARD, ONLINE
  accountNumber String?
  createdAt   DateTime @default(now())
  
  transactions Transaction[]
}

model CreditCustomer {
  id            String   @id @default(uuid())
  name          String   @unique
  vehicleNumber String?
  totalCredit   Decimal  @default(0) @db.Decimal(15, 2)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  
  creditRecords CreditRecord[]
  transactions  Transaction[]
}

model CreditRecord {
  id              String   @id @default(uuid())
  customerId      String
  customer        CreditCustomer @relation(fields: [customerId], references: [id])
  amount          Decimal  @db.Decimal(15, 2)
  remainingAmount Decimal  @db.Decimal(15, 2)
  creditDate      DateTime @default(now())
  createdAt       DateTime @default(now())
}

// Transaction moved to bottom with new relations

model NotificationQueue {
  id        String   @id @default(uuid())
  to        String
  message   String
  status    String   @default("PENDING") // PENDING, SENT, FAILED
  retries   Int      @default(0)
  lastError String?
  createdAt DateTime @default(now())
}

model NotificationPreferences {
  id                String   @id @default(uuid())
  phoneNumber       String   @unique
  
  // Main notification toggles (backup is always enabled)
  salesNotifications    Boolean @default(true)
  shiftNotifications    Boolean @default(true)
  inventoryNotifications Boolean @default(true)
  stockNotifications    Boolean @default(true)
  
  // Sales notification sub-options (only if salesNotifications is true)
  notifyCash        Boolean @default(true)
  notifyCard        Boolean @default(true)
  notifyOnline      Boolean @default(true)
  notifyCredit      Boolean @default(true)
  
  // Minimum amounts per payment method
  minCashAmount     Decimal  @default(0) @db.Decimal(10, 2)
  minCardAmount     Decimal  @default(0) @db.Decimal(10, 2)
  minOnlineAmount   Decimal  @default(0) @db.Decimal(10, 2)
  minCreditAmount   Decimal  @default(0) @db.Decimal(10, 2)
  
  // Auto shift management
  autoCloseShift    Boolean @default(false)
  
  // Low fuel alert threshold
  lowFuelThreshold  Int     @default(20) // Percentage
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}


enum PaymentStatus {
  PAID
  UNPAID
  PARTIAL
}

model Supplier {
  id        String   @id @default(uuid())
  name      String   @unique
  contact   String?
  balance   Decimal  @default(0) @db.Decimal(15, 2) // Positive means we owe them (Liability)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  purchases     Purchase[]
  transactions  Transaction[]
}

model Purchase {
  id          String   @id @default(uuid())
  supplierId  String
  supplier    Supplier @relation(fields: [supplierId], references: [id])
  tankId      String
  tank        Tank     @relation(fields: [tankId], references: [id])
  quantity    Decimal  @db.Decimal(10, 2)
  rate        Decimal  @db.Decimal(10, 2) // Per liter cost
  totalCost   Decimal  @db.Decimal(15, 2)
  paidAmount  Decimal  @default(0) @db.Decimal(15, 2)
  status      PaymentStatus @default(UNPAID)
  description String?
  date        DateTime @default(now())
  createdAt   DateTime @default(now())
}

model ExpenseRecord {
  id          String   @id @default(uuid())
  title       String
  amount      Decimal  @db.Decimal(15, 2)
  category    String   // e.g. "Utilities", "Wages"
  description String?
  date        DateTime @default(now())
  
  // Link to the actual accounting transaction
  transactionId String? @unique
  transaction   Transaction? @relation(fields: [transactionId], references: [id])

  createdBy   String?
}

// ... existing models ...

model Transaction {
  id              String   @id @default(uuid())
  shiftId         String?
  shift           Shift?   @relation(fields: [shiftId], references: [id])
  
  debitAccountId  String
  debitAccount    Account  @relation("DebitAccount", fields: [debitAccountId], references: [id])
  
  creditAccountId String
  creditAccount   Account  @relation("CreditAccount", fields: [creditAccountId], references: [id])
  
  supplierId      String?
  supplier        Supplier? @relation(fields: [supplierId], references: [id])

  customerId      String?
  customer        CreditCustomer? @relation(fields: [customerId], references: [id])

  expenseRecord   ExpenseRecord?

  createdById     String?
  createdBy       User?    @relation("TransactionCreator", fields: [createdById], references: [id])

  paymentAccountId String?
  paymentAccount   PaymentAccount? @relation(fields: [paymentAccountId], references: [id])

  nozzleId        String?
  nozzle          Nozzle?  @relation(fields: [nozzleId], references: [id])

  productId       String?
  product         Product? @relation(fields: [productId], references: [id])

  quantity        Decimal? @db.Decimal(10, 2)
  amount          Decimal  @db.Decimal(15, 2)
  profit          Decimal? @db.Decimal(15, 2) // Profit on sales
  description     String?
  createdAt       DateTime @default(now())
}
